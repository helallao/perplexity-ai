"""\nPydantic модели для Perplexity API клиента\nОснованы на анализе реальных SSE потоков и API responses\n"""\nfrom typing import Optional, List, Dict, Any, Literal\nfrom pydantic import BaseModel, Field\nfrom datetime import datetime\nfrom uuid import UUID\n\n\n# ==================== Базовые модели ====================\n\nclass SearchFilter(BaseModel):\n    """Фильтры поискового запроса"""\n    recency_filter: Optional[str] = Field(None, description=\"recent, day, week, month, year\")\n    search_domain_filter: Optional[List[str]] = None\n\n\nclass Citation(BaseModel):\n    """Цитата/источник в ответе"""\n    index: int\n    url: str\n    title: Optional[str] = None\n    snippet: Optional[str] = None\n    domain: Optional[str] = None\n    favicon: Optional[str] = None\n\n\nclass WebResult(BaseModel):\n    """Результат веб-поиска"""\n    url: str\n    title: str\n    snippet: str\n    domain: Optional[str] = None\n    published_date: Optional[str] = None\n    favicon: Optional[str] = None\n\n\n# ==================== Thread/Entry модели ====================\n\nclass ThreadInfo(BaseModel):\n    """Информация о треде/беседе"""\n    uuid: str = Field(..., description=\"Frontend context UUID\")\n    backend_uuid: Optional[str] = Field(None, description=\"Backend thread UUID\")\n    thread_url_slug: Optional[str] = Field(None, description=\"URL slug для треда\")\n    title: Optional[str] = None\n    created_at: Optional[datetime] = None\n    is_new: bool = False\n\n\nclass EntryData(BaseModel):\n    """Данные одной записи в треде"""\n    backend_uuid: str\n    context_uuid: str\n    query_str: str\n    text: Optional[str] = None\n    answer_html: Optional[str] = None\n    web_results: Optional[List[WebResult]] = []\n    citations: Optional[List[Citation]] = []\n    mode: Optional[str] = \"default\"\n    model: Optional[str] = None\n    status: Optional[str] = \"completed\"\n    widgets: Optional[List[Dict[str, Any]]] = []\n    related_queries: Optional[List[str]] = []\n\n\n# ==================== Request/Response ====================\n\nclass PerplexityAskRequest(BaseModel):\n    """Запрос к основному эндпоинту /ask"""\n    query: str = Field(..., min_length=1, max_length=4000)\n    frontend_context_uuid: Optional[str] = Field(None, description=\"UUID треда для продолжения\")\n    backend_uuid: Optional[str] = Field(None, description=\"Backend UUID треда\")\n    mode: Optional[Literal[\"default\", \"pro\", \"focus\"]] = \"default\"\n    search_recency_filter: Optional[str] = None\n    search_domain_filter: Optional[List[str]] = None\n    model: Optional[str] = Field(None, description=\"claude-3.7-sonnet, gpt-4o, etc\")\n    file_upload_info: Optional[List[Dict[str, Any]]] = []\n    stream: bool = True\n\n\nclass PerplexityAskResponse(BaseModel):\n    """Полный ответ от /ask (собранный из SSE стрима)"""\n    backend_uuid: str\n    context_uuid: str\n    thread_url_slug: Optional[str] = None\n    text: str = Field(..., description=\"Полный текст ответа с markdown\")\n    web_results: List[WebResult] = Field(default_factory=list)\n    citations: List[Citation] = Field(default_factory=list)\n    query_str: str\n    mode: str = \"default\"\n    model: Optional[str] = None\n    status: str = \"completed\"\n    related_queries: List[str] = Field(default_factory=list)\n    widgets: List[Dict[str, Any]] = Field(default_factory=list)\n    search_focus: Optional[str] = None\n    created_at: Optional[datetime] = None\n    updated_at: Optional[datetime] = None\n\n\n# ==================== Thread History ====================\n\nclass ThreadEntry(BaseModel):\n    """Запись в истории треда"""\n    backend_uuid: str\n    context_uuid: str\n    query_str: str\n    text: Optional[str] = None\n    web_results: List[WebResult] = Field(default_factory=list)\n    status: str = \"completed\"\n    created_at: Optional[datetime] = None\n\n\nclass ThreadHistory(BaseModel):\n    """История всего треда"""\n    uuid: str\n    backend_uuid: Optional[str] = None\n    thread_url_slug: Optional[str] = None\n    title: Optional[str] = None\n    entries: List[ThreadEntry] = Field(default_factory=list)\n    created_at: Optional[datetime] = None\n    updated_at: Optional[datetime] = None\n\n\nclass ThreadMetadata(BaseModel):\n    """Метаданные для отображения треда в UI клиента"""\n    thread_url: str = Field(..., description=\"Полная ссылка на тред perplexity.ai/search/{slug}\")\n    title: str\n    preview: Optional[str] = Field(None, description=\"Первые 150 символов\")\n    entries_count: int\n    last_updated: datetime\n\n\nclass CompleteChatThread(BaseModel):\n    """\n    Полная структура для клиента:\n    - метаданные треда\n    - вся история запросов/ответов\n    - ссылка на оригинал\n    """\n    metadata: ThreadMetadata\n    history: ThreadHistory\n\n    def get_markdown_output(self) -> str:\n        """Экспорт всего треда в markdown"""\n        lines = [\n            f\"# {self.metadata.title}\",\n            f\"\",\n            f\"**Thread URL:** {self.metadata.thread_url}\",\n            f\"**Last Updated:** {self.metadata.last_updated}\",\n            f\"**Entries:** {self.metadata.entries_count}\",\n            f\"\",\n            \"---\",\n            \"\"\n        ]\n\n        for idx, entry in enumerate(self.history.entries, 1):\n            lines.append(f\"## Query {idx}: {entry.query_str}\")\n            lines.append(\"\")\n            lines.append(entry.text or \"_No response_\")\n            lines.append(\"\")\n\n            if entry.web_results:\n                lines.append(\"### Sources:\")\n                for source in entry.web_results:\n                    lines.append(f\"- [{source.title}]({source.url})\")\n                lines.append(\"\")\n\n            lines.append(\"---\")\n            lines.append(\"\")\n\n        return \"\\n\".join(lines)\n